global
  daemon
  log 127.0.0.1 local0
  log 127.0.0.1 local1 notice
  maxconn 4096
  tune.ssl.default-dh-param 2048

defaults
  log               global
  retries           3
  maxconn           2000
  timeout connect   5s
  timeout client    50s
  timeout server    50s

frontend http-in
  bind *:80
  mode http
{{ range $index, $app := .Apps }}
  acl http_{{ $app.EscapedId }}_{{ $app.ServicePort }}_acl hdr(host) -i {{ $app.HaproxyVHost }}
  use_backend {{ $app.EscapedId }}_{{ $app.ServicePort }}_backend if http_{{ $app.EscapedId }}_{{ $app.ServicePort }}_acl
{{ end }}

{{ if .Apps.HasSSLCertID }}
frontend https-in
  bind *:443 ssl {{ range $index, $certId := .Apps.GetSSLCertIDs }} crt /etc/ssl/marathon/{{ $certId }}.pem {{ end }}
  mode http
{{ range $index, $app := .Apps }}
  acl https_{{ $app.EscapedId }}_{{ $app.ServicePort }}_acl hdr(host) -i {{ $app.HaproxyVHost }}
  use_backend {{ $app.EscapedId }}_{{ $app.ServicePort }}_backend if https_{{ $app.EscapedId }}_{{ $app.ServicePort }}_acl
{{ end }}
{{ end }}

{{ range $index, $app := .Apps }}
frontend {{ $app.EscapedId }}_{{ $app.ServicePort }}_frontend
  bind *:{{ $app.ServicePort }} {{if $app.HaproxySSLCertID }}ssl crt /etc/ssl/marathon/{{ $app.HaproxySSLCertID }}.pem {{ end }}
  mode {{ $app.HaproxyMode }}
  use_backend {{ $app.EscapedId }}_{{ $app.ServicePort }}_backend

backend {{ $app.EscapedId }}_{{ $app.ServicePort }}_backend
  mode {{ $app.HaproxyMode }}{{ if $app.HaproxyRedirectToHTTPS }}
  redirect scheme https if !{ ssl_fc } {{ end }}
  balance {{ $app.HaproxyBalance }}
  option {{ $app.HaproxyMode }}log{{ if eq $app.HaproxyMode "http" }}
  option forwardfor
  http-request set-header X-Forwarded-Port %[dst_port]
  http-request add-header X-Forwarded-Proto https if { ssl_fc }{{ end }}{{ if $app.HaproxySticky }}
  cookie dkos_server_id insert indirect nocache {{ end }}
  {{ range $page, $task := .Tasks }}
  server {{ $app.EscapedId}}-{{ $task.Host }}-{{ $task.Port }} {{ $task.Host }}:{{ $task.Port }} {{ if $app.HealthCheckPath }} check {{ if $app.HaproxySticky }}cookie {{ $app.EscapedId}}-{{ $task.Host }}-{{ $task.Port }}{{ end }} {{ end }} {{ end }}
  {{ range $key, $value := $app.ExternalProxyMap }}

listen external_proxy_{{ $key }}
  bind *:{{ $key }}
  mode tcp
  option tcplog
  balance roundrobin

  server external_proxy_server_{{ $key }} {{ $value }} check
  {{ end }}
{{ end }}
